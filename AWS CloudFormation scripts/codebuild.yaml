AWSTemplateFormatVersion: 2010-09-09

Description: 
  This template will create a Build for the application.
  AWS::CodeBuild::Project Artifacts >>> docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codebuild-project-artifacts.html#cfn-codebuild-project-artifacts-name
  Artifacts is a property of the AWS::CodeBuild::Project resource that specifies output settings for artifacts generated by an AWS CodeBuild build.
  In this project we have used S3 as the build project stores build output in Amazon S3

Parameters:
  CodeBuildProjectName:
    Type: String
    Description: Only alphanumeric characters, dash, and underscore are supported .
  CodeCommitRepoURL:
    Type: String
    Description: The HTTPS clone URL to the repository 
  RepositoryName: 
    Type: String
    Description: Name of CodeCommit repository 
  ProjectName:
    Type: String
    Description: Name of the project you want to be deployed in CodeCommit
  #OutputArtifactPath:
    #Type: String
    #Description: The pattern that AWS CodeBuild uses to name and store the output artifact
  #OutputArtifactNamespaceType:
    #Type: String
    #Description: The pattern that AWS CodeBuild uses to determine the name and location to store the output
  #OutputArtifactName: 
    #Type: String
    #Description: The pattern that AWS CodeBuild uses to name and store the output artifact
  #Packaging:
    #Type: String 
    #Description: The type of build output artifact to create
    #Default: ZIP
  IndexDocumentName: 
    Type: String
    Description: Index page of the project
    Default: index.html
  ErrorDocumentName: 
    Type: String
    Description: Error page of the project 
    Default: error.html

Resources:
  
  # S3 bucket where build artifacts go
  DeploymentArtifactBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      AccessControl: PublicRead #BucketOwnerFullControl
      #PublicAccessBlockConfiguration: 
      VersioningConfiguration:
        Status: Suspended
      WebsiteConfiguration:
        IndexDocument: !Ref IndexDocumentName
        ErrorDocument: !Ref ErrorDocumentName
        #RoutingRules:
          #- RoutingRuleCondition:
              #<<<      >>>

  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRole
            Principal:
              Service:
                - codebuild.amazonaws.com
                
  CodeBuildServicePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CodeBuildServicePolicy
      Roles:
        - !Ref CodeBuildServiceRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: "arn:aws:logs:*:*:*"
          - Effect: Allow
            Action: '*'
              #- s3:GetObject
              #- s3:GetObjectVersion
              #- s3:PutObject
            Resource: '*'

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Description: We are setting our Artifacts parameter to be S3 and putting our builds in folder named after BUILD_ID in S3 bucket
    Properties: 
      Artifacts:
        #Type: NO_ARTIFACTS #The build project does not produce any build output
        Type: NO_ARTIFACTS #The build project has build output generated through CodePipeline
        #Type: S3           #The build project stores build output in Amazon S3
        #Location: !Ref DeploymentArtifactBucket          #bucket name
        #EncryptionDisabled: True
        #Path: NONE
        #NamespaceType: BUILD_ID
        #Name: !Ref OutputArtifactName
        #If path is set to MyArtifacts, namespaceType is set to BUILD_ID, and name is set to MyArtifact.zip, then the output artifact is stored in MyArtifacts/build-ID/MyArtifact.zip.
        #Packaging: !Ref Packaging
      Source:
        Type: CODECOMMIT
        Location: 
          Fn::Join:
            - ""
            - - "https://git-codecommit."
              - Ref: AWS::Region
              - ".amazonaws.com/v1/repos/"
              - Ref: RepositoryName
        GitCloneDepth: 1
      Description: CodeBuild for the project
      Environment: 
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:1.0
        EnvironmentVariables:
          - Name: BUILD_ARTIFACT_BUCKET
            Value: !Ref DeploymentArtifactBucket
      Name: !Ref CodeBuildProjectName
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Tags: 
        - 
          Key: Name
          Value: !Ref ProjectName
      TimeoutInMinutes: 10



Outputs:
  BuildArn:
    Description: Arn of the CodeBuild Project
    Value: !GetAtt CodeBuildProject.Arn
  S3Arn:
    Description: Arn of the S3 bucket
    Value: !GetAtt DeploymentArtifactBucket.Arn
  IAMRoleArn:
    Description: Arn of IAM role
    Value: !GetAtt CodeBuildServiceRole.Arn
  IAMRoleId: 
    Description: Role ID of IAM role
    Value: !GetAtt CodeBuildServiceRole.RoleId
  